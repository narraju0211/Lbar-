<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Controle de Patrocínio L-Bar</title>
    <style>
        /* Estilos CSS para o layout e aparência do painel de controle */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 20px;
            background-color: #f0f2f5;
            color: #333;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .container {
            background-color: #fff;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 550px;
            margin: 0 auto;
            box-sizing: border-box;
        }

        h1 {
            color: #007bff;
            text-align: center;
            margin-bottom: 30px;
            font-size: 1.8em;
        }

        .section-title {
            font-size: 1.3em;
            color: #555;
            margin-bottom: 15px;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
         }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #666;
        }

        input,
        textarea {
            width: calc(100% - 20px);
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1em;
            box-sizing: border-box;
        }

        textarea {
            resize: vertical;
            min-height: 80px;
        }

        input::-webkit-outer-spin-button,
        input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        input#leftBackgroundOpacity {
            width: 100%;
        }

        input[type="file"] {
            padding: 5px 0;
        }

        .preview-logo, .preview-background, .preview-bottom-image {
            margin-top: 10px;
            text-align: center;
            border: 1px solid #eee;
            border-radius: 5px;
            padding: 5px;
            background-color: #fdfdfd;
            height: 80px; /* Altura menor para otimizar espaço */
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .preview-logo img, .preview-background img, .preview-bottom-image img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            display: none;
        }
        .preview-logo img:not([src=""]),
        .preview-background img:not([src=""]),
        .preview-bottom-image img:not([src=""]) {
            display: block;
        }

        button {
            display: block;
            width: 100%;
            padding: 12px 20px;
            margin-top: 10px;
            border: none;
            border-radius: 5px;
            font-size: 1.1em;
            cursor: pointer;
            transition: background-color 0.3s ease;
            color: #fff;
        }

        button.toggle-button {
            background-color: #28a745;
        }
        button.toggle-button.active {
            background-color: #dc3545;
        }
        button.toggle-button:hover {
            opacity: 0.9;
        }

        button.set-sponsor-button {
            background-color: #007bff;
            margin-bottom: 15px;
        }
        button.set-sponsor-button:hover {
            background-color: #0056b3;
        }

        .current-visibility {
            text-align: center;
            font-size: 1.1em;
            margin-bottom: 20px;
            font-weight: bold;
        }
        .current-visibility span.on { color: #28a745; }
        .current-visibility span.off { color: #dc3545; }

        .note {
            font-size: 0.8em;
            color: #888;
            margin-top: 5px;
        }

        .sponsor-slots {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .slot {
            border: 1px solid #eee;
            padding: 15px;
            border-radius: 5px;
            background-color: #fdfdfd;
        }

        .slot-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .slot-header h3 {
            margin: 0;
            color: #333;
            font-size: 1.1em;
        }

        .opacity-control {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
        }

        .opacity-control span {
            width: 30px;
            text-align: right;
            font-size: 0.9em;
            color: #777;
        }
    </style>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
</head>
<body>
    <div class="container">
        <h1>Controle de Patrocínio L-Bar</h1>

        <div class="current-visibility">
            Estado da Overlay: <span id="visibilityStatus">Carregando...</span>
        </div>
        <button id="toggleVisibilityBtn" class="toggle-button">Carregando...</button>
    </div>

    <div class="container sponsor-slots">
        <div class="section-title">Configuração da Barra Lateral Esquerda</div>
        <div class="slot">
            <div class="form-group">
                <label for="leftSponsorLogo">Logo da Empresa (o nome da empresa será exibido):</label>
                <input type="file" id="leftSponsorLogo" accept="image/*">
                <div class="preview-logo">
                    <img id="leftLogoPreview" src="" alt="Pré-visualização da Logo Esquerda">
                </div>
                <span class="note">Formatos: PNG, JPG. Tamanho máximo: 1MB. O *texto alternativo (alt)* da imagem será o nome da empresa exibido com destaque.</span>
            </div>
            <div class="form-group">
                <label for="leftSegmentInfo">Informações do Segmento:</label>
                <textarea id="leftSegmentInfo" placeholder="Ex: Tecnologia, Eventos, etc."></textarea>
            </div>
            <div class="form-group">
                <label for="leftContactInfo">Contato e Atendimento:</label>
                <textarea id="leftContactInfo" placeholder="Ex: (XX) XXXX-XXXX, www.site.com.br, Seg-Sex 9h-18h"></textarea>
            </div>
            <div class="form-group">
                <label for="leftBackgroundImage">Imagem de Fundo (Para Ambas as Barras):</label>
                <input type="file" id="leftBackgroundImage" accept="image/*">
                <div class="preview-background">
                    <img id="leftBackgroundPreview" src="" alt="Pré-visualização do Fundo Esquerdo">
                </div>
                <span class="note">Esta imagem preencherá o fundo da barra lateral E da barra inferior. Formatos: PNG, JPG. Tamanho máximo: 1MB.</span>
            </div>
            <div class="form-group opacity-control">
                <label for="leftBackgroundOpacity">Transparência do Fundo (Para Ambas):</label>
                <input type="range" id="leftBackgroundOpacity" min="0" max="1" step="0.05" value="1">
                <span id="leftOpacityValue">1.00</span>
            </div>
            <button class="set-sponsor-button" onclick="setSponsor('left')">Atualizar Barra Esquerda & Fundo</button>
        </div>

        <div class="section-title">Configuração da Barra Inferior (3 Imagens)</div>
        <div class="slot">
            <div class="form-group">
                <label for="bottomImage1">Imagem 1 (principal):</label>
                <input type="file" id="bottomImage1" accept="image/*">
                <div class="preview-bottom-image">
                    <img id="bottomPreview1" src="" alt="Pré-visualização Imagem 1">
                </div>
                <span class="note">Formatos: PNG, JPG. Tamanho máximo por imagem: 1MB.</span>
            </div>
            <div class="form-group">
                <label for="bottomImage2">Imagem 2 (opcional):</label>
                <input type="file" id="bottomImage2" accept="image/*">
                <div class="preview-bottom-image">
                    <img id="bottomPreview2" src="" alt="Pré-visualização Imagem 2">
                </div>
                <span class="note">Formatos: PNG, JPG. Tamanho máximo por imagem: 1MB.</span>
            </div>
            <div class="form-group">
                <label for="bottomImage3">Imagem 3 (opcional):</label>
                <input type="file" id="bottomImage3" accept="image/*">
                <div class="preview-bottom-image">
                    <img id="bottomPreview3" src="" alt="Pré-visualização Imagem 3">
                </div>
                <span class="note">Formatos: PNG, JPG. Tamanho máximo por imagem: 1MB.</span>
            </div>
            <button class="set-sponsor-button" onclick="setSponsor('bottom')">Atualizar Barra Inferior</button>
        </div>
    </div>

    <script>
        // ** SEU FIREBASE CONFIG ESTÁ AQUI **
        const firebaseConfig = {
          apiKey: "AIzaSyAFp_iujrtqjiTU5yq2yNSBIpwgjQZZyns",
          authDomain: "aquilesplacarpro.firebaseapp.com",
          databaseURL: "https://aquilesplacarpro-default-rtdb.firebaseio.com",
          projectId: "aquilesplacarpro",
          storageBucket: "aquilesplacarpro.firebasestorage.app",
          messagingSenderId: "922321609151",
          appId: "1:922321609151:web:ba51f5b21b322cf0a4c10a"
        };

        // Inicializa o Firebase com suas configurações
        const app = firebase.initializeApp(firebaseConfig);
        const database = app.database();
        const sponsorStateRef = database.ref('sponsorOverlayState');

        // Elementos HTML
        const toggleVisibilityBtn = document.getElementById('toggleVisibilityBtn');
        const visibilityStatus = document.getElementById('visibilityStatus');

        // Left Bar Elements
        const leftSponsorLogoInput = document.getElementById('leftSponsorLogo');
        const leftLogoPreview = document.getElementById('leftLogoPreview');
        const leftSegmentInfoTextarea = document.getElementById('leftSegmentInfo');
        const leftContactInfoTextarea = document.getElementById('leftContactInfo');
        const leftBackgroundImageInput = document.getElementById('leftBackgroundImage');
        const leftBackgroundPreview = document.getElementById('leftBackgroundPreview');
        const leftBackgroundOpacitySlider = document.getElementById('leftBackgroundOpacity');
        const leftOpacityValueSpan = document.getElementById('leftOpacityValue');

        // Bottom Bar Elements
        const bottomImageInput1 = document.getElementById('bottomImage1');
        const bottomPreview1 = document.getElementById('bottomPreview1');
        const bottomImageInput2 = document.getElementById('bottomImage2');
        const bottomPreview2 = document.getElementById('bottomPreview2');
        const bottomImageInput3 = document.getElementById('bottomImage3');
        const bottomPreview3 = document.getElementById('bottomPreview3');

        const MAX_FILE_SIZE = 1 * 1024 * 1024; // 1MB

        function setupImageInput(inputElement, previewElement) {
            inputElement.addEventListener('change', (event) => {
                const file = event.target.files?.[0];
                if (file) {
                    if (file.size > MAX_FILE_SIZE) {
                        alert(`O arquivo selecionado (${(file.size / (1024 * 1024)).toFixed(2)} MB) é muito grande. Máximo: 1MB.`);
                        inputElement.value = '';
                        previewElement.src = '';
                        previewElement.style.display = 'none';
                        return;
                    }
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        previewElement.src = e.target.result;
                        previewElement.style.display = 'block';
                    };
                    reader.readAsDataURL(file);
                } else {
                    previewElement.src = '';
                    previewElement.style.display = 'none';
                }
            });
        }

        setupImageInput(leftSponsorLogoInput, leftLogoPreview);
        setupImageInput(leftBackgroundImageInput, leftBackgroundPreview);
        setupImageInput(bottomImageInput1, bottomPreview1);
        setupImageInput(bottomImageInput2, bottomPreview2);
        setupImageInput(bottomImageInput3, bottomPreview3);

        function updateOpacityValue(sliderElement, valueSpan) {
            sliderElement.addEventListener('input', () => {
                valueSpan.textContent = parseFloat(sliderElement.value).toFixed(2);
            });
        }

        updateOpacityValue(leftBackgroundOpacitySlider, leftOpacityValueSpan);

        sponsorStateRef.on('value', (snapshot) => {
            const state = snapshot.val();
            if (state && typeof state.isVisible !== 'undefined') {
                updateToggleButton(state.isVisible);
                updateVisibilityStatus(state.isVisible);

                // Left Bar
                if (state.leftSponsor) {
                    leftLogoPreview.src = state.leftSponsor.logo || '';
                    leftLogoPreview.alt = state.leftSponsor.logoText || ''; // Atualiza o alt text do preview
                    leftLogoPreview.style.display = state.leftSponsor.logo ? 'block' : 'none';
                    leftSegmentInfoTextarea.value = state.leftSponsor.segmentInfo || '';
                    leftContactInfoTextarea.value = state.leftSponsor.contactInfo || '';
                    leftBackgroundPreview.src = state.leftSponsor.backgroundImage || '';
                    leftBackgroundPreview.style.display = state.leftSponsor.backgroundImage ? 'block' : 'none';
                    leftBackgroundOpacitySlider.value = state.leftSponsor.backgroundOpacity !== undefined ? state.leftSponsor.backgroundOpacity : 1;
                    leftOpacityValueSpan.textContent = parseFloat(leftBackgroundOpacitySlider.value).toFixed(2);
                } else {
                    leftLogoPreview.src = ''; leftLogoPreview.alt = ''; leftLogoPreview.style.display = 'none';
                    leftSegmentInfoTextarea.value = '';
                    leftContactInfoTextarea.value = '';
                    leftBackgroundPreview.src = ''; leftBackgroundPreview.style.display = 'none';
                    leftBackgroundOpacitySlider.value = 1; leftOpacityValueSpan.textContent = '1.00';
                }

                // Bottom Bar Images
                if (state.bottomSponsorImages) {
                    bottomPreview1.src = state.bottomSponsorImages[0] || '';
                    bottomPreview1.style.display = state.bottomSponsorImages[0] ? 'block' : 'none';
                    bottomPreview2.src = state.bottomSponsorImages[1] || '';
                    bottomPreview2.style.display = state.bottomSponsorImages[1] ? 'block' : 'none';
                    bottomPreview3.src = state.bottomSponsorImages[2] || '';
                    bottomPreview3.style.display = state.bottomSponsorImages[2] ? 'block' : 'none';
                } else {
                    bottomPreview1.src = ''; bottomPreview1.style.display = 'none';
                    bottomPreview2.src = ''; bottomPreview2.style.display = 'none';
                    bottomPreview3.src = ''; bottomPreview3.style.display = 'none';
                }

            } else {
                updateToggleButton(false);
                updateVisibilityStatus(false);
            }
        }, (error) => {
            console.error("Erro ao ler dados do Firebase:", error);
            visibilityStatus.textContent = "Erro de conexão";
            toggleVisibilityBtn.textContent = "Erro";
            toggleVisibilityBtn.disabled = true;
        });

        function updateToggleButton(isVisible) {
            toggleVisibilityBtn.textContent = isVisible ? 'Desligar Overlay' : 'Ligar Overlay';
            toggleVisibilityBtn.classList.toggle('active', isVisible);
            toggleVisibilityBtn.disabled = false;
        }

        function updateVisibilityStatus(isVisible) {
            visibilityStatus.innerHTML = `<span class="${isVisible ? 'on' : 'off'}">${isVisible ? 'LIGADA' : 'DESLIGADA'}</span>`;
        }

        toggleVisibilityBtn.addEventListener('click', () => {
            const currentState = toggleVisibilityBtn.classList.contains('active');
            sponsorStateRef.update({ isVisible: !currentState })
                .then(() => console.log('Visibilidade atualizada!'))
                .catch(error => console.error('Erro ao atualizar visibilidade:', error));
        });

        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
            });
        }

        async function setSponsor(slot) {
            if (slot === 'left') {
                const logoFile = leftSponsorLogoInput.files?.[0];
                const segmentInfo = leftSegmentInfoTextarea.value;
                const contactInfo = leftContactInfoTextarea.value;
                const backgroundImageFile = leftBackgroundImageInput.files?.[0];
                const backgroundOpacity = parseFloat(leftBackgroundOpacitySlider.value);

                if (logoFile && logoFile.size > MAX_FILE_SIZE) {
                    alert(`O arquivo da logo é muito grande (max 1MB).`);
                    leftSponsorLogoInput.value = '';
                    return;
                }
                if (backgroundImageFile && backgroundImageFile.size > MAX_FILE_SIZE) {
                    alert(`O arquivo de fundo é muito grande (max 1MB).`);
                    leftBackgroundImageInput.value = '';
                    return;
                }

                let logoBase64 = logoFile ? await fileToBase64(logoFile) : leftLogoPreview.src || '';
                let logoText = logoFile ? logoFile.name.split('.')[0] : leftLogoPreview.alt || ''; // Usar nome do arquivo como texto, ou o alt existente
                let backgroundImageBase64 = backgroundImageFile ? await fileToBase64(backgroundImageFile) : leftBackgroundPreview.src || '';

                const updateData = {
                    leftSponsor: {
                        logo: logoBase64,
                        logoText: logoText, // Salva o texto da logo no Firebase
                        segmentInfo: segmentInfo,
                        contactInfo: contactInfo,
                        backgroundImage: backgroundImageBase64,
                        backgroundOpacity: backgroundOpacity
                    }
                };
                sponsorStateRef.update(updateData)
                    .then(() => alert('Barra Esquerda & Fundo atualizados!'))
                    .catch(error => console.error('Erro ao atualizar Barra Esquerda:', error));

            } else if (slot === 'bottom') {
                const imageFile1 = bottomImageInput1.files?.[0];
                const imageFile2 = bottomImageInput2.files?.[0];
                const imageFile3 = bottomImageInput3.files?.[0];
                const bottomImages = [];

                async function processFile(file, index) {
                    if (file) {
                        if (file.size > MAX_FILE_SIZE) {
                            alert(`A Imagem ${index + 1} é muito grande (max 1MB).`);
                            if (index === 0) bottomImageInput1.value = '';
                            if (index === 1) bottomImageInput2.value = '';
                            if (index === 2) bottomImageInput3.value = '';
                            return null; // Indica que o arquivo é inválido
                        }
                        return await fileToBase64(file);
                    }
                    // Se não houver novo arquivo, tenta manter o existente do Firebase
                    const stateSnapshot = await sponsorStateRef.get();
                    const currentState = stateSnapshot.val();
                    return currentState?.bottomSponsorImages?.[index] || '';
                }

                // Processa cada arquivo, esperando que as promessas sejam resolvidas
                const img1 = await processFile(imageFile1, 0);
                const img2 = await processFile(imageFile2, 1);
                const img3 = await processFile(imageFile3, 2);

                // Adiciona apenas as imagens válidas ao array
                if (img1 !== null) bottomImages.push(img1);
                if (img2 !== null) bottomImages.push(img2);
                if (img3 !== null) bottomImages.push(img3);

                sponsorStateRef.update({ bottomSponsorImages: bottomImages })
                    .then(() => alert('Barra Inferior atualizada!'))
                    .catch(error => console.error('Erro ao atualizar Barra Inferior:', error));
            }
        }
    </script>
</body>
</html>
